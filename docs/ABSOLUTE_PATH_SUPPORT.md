# âœ… ç»å¯¹è·¯å¾„æ”¯æŒå·²å®ç°

## ğŸ‰ é‡å¤§æ›´æ–°

ç»è¿‡ç”¨æˆ·åé¦ˆå’Œé‡æ–°è¯„ä¼°ï¼Œ**ç°åœ¨å·²å®Œå…¨æ”¯æŒç»å¯¹è·¯å¾„å›¾ç‰‡**ï¼

## ğŸ“Š æ”¯æŒçš„è·¯å¾„ç±»å‹ï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰

| è·¯å¾„ç±»å‹ | ç¤ºä¾‹ | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|------|
| ç›¸å¯¹è·¯å¾„ï¼ˆåŒç›®å½•ï¼‰ | `./image.png` | âœ… å®Œç¾æ”¯æŒ | - |
| ç›¸å¯¹è·¯å¾„ï¼ˆå­ç›®å½•ï¼‰ | `./images/logo.png` | âœ… å®Œç¾æ”¯æŒ | - |
| ç›¸å¯¹è·¯å¾„ï¼ˆä¸Šçº§ç›®å½•ï¼‰ | `../image.png` | âœ… å®Œç¾æ”¯æŒ | - |
| **ç»å¯¹è·¯å¾„** | `/Users/Shared/image.png` | âœ… **æ–°å¢æ”¯æŒ** | ğŸ†• |
| **file:// åè®®** | `file:///Users/Shared/image.png` | âœ… **æ–°å¢æ”¯æŒ** | ğŸ†• |
| ç½‘ç»œå›¾ç‰‡ (HTTPS) | `https://example.com/img.png` | âœ… å®Œç¾æ”¯æŒ | - |
| ç½‘ç»œå›¾ç‰‡ (HTTP) | `http://example.com/img.png` | âš ï¸  å¯èƒ½è¢«é˜»æ­¢ | WKWebView å®‰å…¨ç­–ç•¥ |
| Base64 å†…åµŒ | `data:image/png;base64,...` | âœ… å®Œç¾æ”¯æŒ | - |

---

## ğŸ”§ å®ç°ç»†èŠ‚

### ä¹‹å‰çš„é™åˆ¶

```swift
// æ—§ä»£ç ï¼šç»å¯¹è·¯å¾„è¢«è¿‡æ»¤æ‰
if imagePath.starts(with: "/") || imagePath.starts(with: "file://") {
    continue  // è·³è¿‡ï¼Œä¸å°è¯•åŠ è½½
}
```

### ç°åœ¨çš„å®ç°

```swift
// æ–°ä»£ç ï¼šæ”¯æŒç»å¯¹è·¯å¾„
if imagePath.starts(with: "file://") {
    cleanPath = String(imagePath.dropFirst("file://".count))
    imageURL = URL(fileURLWithPath: cleanPath)
} else if imagePath.starts(with: "/") {
    imageURL = URL(fileURLWithPath: imagePath)
} else {
    // å¤„ç†ç›¸å¯¹è·¯å¾„...
}
```

### æƒé™åŸºç¡€

åŠŸèƒ½å®ç°ä¾èµ–äº `temporary-exception` æƒé™ï¼Œå…è®¸è®¿é—®ç”¨æˆ·ä¸»ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼š

```xml
<!-- Sources/MarkdownPreview/MarkdownPreview.entitlements -->
<key>com.apple.security.temporary-exception.files.absolute-path.read-only</key>
<array>
    <string>$HOME/</string>
</array>
```

**æƒé™è¯´æ˜ï¼š**
- âœ… å…è®¸è®¿é—®ï¼š`/Users/username/` åŠå…¶æ‰€æœ‰å­ç›®å½•
- âœ… åŒ…æ‹¬ï¼šDocuments, Downloads, Desktop, Pictures, Projects ç­‰
- âŒ ä¸å…è®¸è®¿é—®ï¼šç³»ç»Ÿç›®å½•ï¼ˆ`/System`, `/Library`ï¼‰ã€å…¶ä»–ç”¨æˆ·ç›®å½•ã€åº”ç”¨ç¨‹åºç›®å½•
- ğŸ”’ å®‰å…¨æ€§ï¼šç›¸æ¯”å…¨å±€ `/` æˆæƒï¼Œå¤§å¹…æå‡äº†å®‰å…¨æ€§

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç»“æœ

```bash
âœ… ç»å¯¹è·¯å¾„: /Users/Shared/test-image.png - æˆåŠŸåŠ è½½ (7594 bytes)
âœ… file:// åè®®: file:///Users/Shared/test-image.png - æˆåŠŸåŠ è½½
âœ… ç›¸å¯¹è·¯å¾„: ./test-image.png - æˆåŠŸåŠ è½½
âœ… ç½‘ç»œå›¾ç‰‡: https://... - æˆåŠŸåŠ è½½
```

### æ—¥å¿—ç¤ºä¾‹

```
ğŸ”µ Trying to load image: /Users/Shared/test-image.png
ğŸŸ¢ Collected image: /Users/Shared/test-image.png (7594 bytes)
ğŸ”µ Collected 7 images from 17 references
```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### Markdown ä¸­ä½¿ç”¨ç»å¯¹è·¯å¾„

```markdown
<!-- æ–¹å¼ 1: ç›´æ¥ä½¿ç”¨ç»å¯¹è·¯å¾„ -->
![My Image](/Users/username/Pictures/photo.png)

<!-- æ–¹å¼ 2: ä½¿ç”¨ file:// åè®® -->
![My Image](file:///Users/username/Pictures/photo.png)

<!-- æ–¹å¼ 3: ç›¸å¯¹è·¯å¾„ï¼ˆä»ç„¶æ¨èï¼‰ -->
![My Image](./images/photo.png)
```

### å®é™…æµ‹è¯•æ–‡æ¡£

å‚è§ `Tests/fixtures/images-test.md`ï¼š

```markdown
## 2. ç»å¯¹è·¯å¾„å›¾ç‰‡

### 2.1 file:// åè®®
![Test Image - File Protocol](file:///Users/Shared/test-image.png)

### 2.2 ç»å¯¹æ–‡ä»¶ç³»ç»Ÿè·¯å¾„
![Test Image - Absolute Path](/Users/Shared/test-image.png)
```

---

## âš ï¸  ä½¿ç”¨æ³¨æ„äº‹é¡¹

### ä¼˜ç‚¹

1. **æ›´å¤§çš„çµæ´»æ€§**ï¼šå¯ä»¥å¼•ç”¨ç”¨æˆ·ä¸»ç›®å½•ä¸‹ä»»æ„ä½ç½®çš„å›¾ç‰‡
2. **é€‚åˆç‰¹å®šåœºæ™¯**ï¼š
   - å¼•ç”¨ç”¨æˆ· Pictures ç›®å½•
   - å¼•ç”¨ç”¨æˆ· Documentsã€Projects ç­‰ç›®å½•
   - å¤šä¸ª Markdown æ–‡æ¡£å…±äº«å›¾ç‰‡åº“

### ç¼ºç‚¹ä¸é™åˆ¶

1. **å¯ç§»æ¤æ€§å·®**ï¼š
   - âŒ ç»å¯¹è·¯å¾„åœ¨ä¸åŒæœºå™¨ä¸Šæ— æ³•å·¥ä½œ
   - âŒ åˆ†äº« Markdown æ–‡ä»¶æ—¶å›¾ç‰‡ä¼šä¸¢å¤±
   
2. **æƒé™ä¾èµ–**ï¼š
   - âš ï¸  éœ€è¦ App Sandbox ä¸´æ—¶ä¾‹å¤–æƒé™
   - âš ï¸  ä»…é™è®¿é—®ç”¨æˆ·ä¸»ç›®å½•ï¼ˆ`$HOME/`ï¼‰
   - âŒ æ— æ³•è®¿é—®ç³»ç»Ÿç›®å½•ï¼ˆå¦‚ `/System/Library/...`ï¼‰
   - âŒ æ— æ³•è®¿é—®å…¶ä»–ç”¨æˆ·ç›®å½•ï¼ˆå¦‚ `/Users/other-user/...`ï¼‰

3. **ä¸ç¬¦åˆ Markdown æœ€ä½³å®è·µ**ï¼š
   - ğŸ“– Markdown æ ‡å‡†æ¨èä½¿ç”¨ç›¸å¯¹è·¯å¾„
   - ğŸ“– ä¾¿äºæ–‡æ¡£å’Œèµ„æºä¸€èµ·ç§»åŠ¨

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### âœ… æ¨èåšæ³•

**ä¼˜å…ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„**ï¼ˆé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼‰ï¼š

```markdown
<!-- æœ€ä½³å®è·µ -->
![Logo](./images/logo.png)
![Screenshot](../screenshots/app.png)
```

**åŸå› ï¼š**
- âœ… å¯ç§»æ¤æ€§å¥½
- âœ… æ–‡æ¡£å’Œå›¾ç‰‡å¯ä»¥ä¸€èµ·ç§»åŠ¨
- âœ… åˆ†äº«æ—¶ä¸ä¼šä¸¢å¤±å›¾ç‰‡
- âœ… ç¬¦åˆ Markdown è§„èŒƒ

### ğŸ”§ é€‚åˆä½¿ç”¨ç»å¯¹è·¯å¾„çš„åœºæ™¯

```markdown
<!-- åœºæ™¯ 1: å¼•ç”¨ç”¨æˆ·å›ºå®šä½ç½®çš„å›¾ç‰‡åº“ -->
![Photo](/Users/username/Pictures/PhotoLibrary/vacation/photo.jpg)

<!-- åœºæ™¯ 2: å¤šæ–‡æ¡£å…±äº«å›¾ç‰‡ï¼ˆç”¨æˆ·ä¸»ç›®å½•ä¸‹ï¼‰ -->
![Logo](/Users/username/Documents/SharedAssets/logo.png)

<!-- åœºæ™¯ 3: è·¨é¡¹ç›®å¼•ç”¨å›¾ç‰‡ -->
![Diagram](/Users/username/Projects/common-resources/diagrams/arch.png)
```

**âš ï¸ æ³¨æ„ï¼š** ç”±äºæ²™ç›’é™åˆ¶ï¼Œä»¥ä¸‹è·¯å¾„æ— æ³•è®¿é—®ï¼š
- âŒ ç³»ç»Ÿç›®å½•ï¼š`/System/...`, `/Library/...`
- âŒ å…¶ä»–ç”¨æˆ·ç›®å½•ï¼š`/Users/other-user/...`
- âŒ `/Users/Shared/...`ï¼ˆä¸åœ¨å½“å‰ç”¨æˆ·ä¸»ç›®å½•ä¸‹ï¼‰

### âŒ ä¸æ¨èçš„åšæ³•

```markdown
<!-- ä¸è¦ç”¨ç»å¯¹è·¯å¾„å¼•ç”¨é¡¹ç›®å†…éƒ¨çš„å›¾ç‰‡ -->
![Bad](Users/username/Projects/myapp/docs/images/logo.png)
<!-- åº”è¯¥ç”¨ç›¸å¯¹è·¯å¾„ -->
![Good](./images/logo.png)
```

---

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»æ—§ç‰ˆæœ¬å‡çº§

å¦‚æœæ‚¨ä¹‹å‰å°è¯•ä½¿ç”¨ç»å¯¹è·¯å¾„ä½†å¤±è´¥äº†ï¼Œç°åœ¨å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹ï¼š

**ä¹‹å‰**ï¼š
- âŒ ç»å¯¹è·¯å¾„å›¾ç‰‡ä¸æ˜¾ç¤º
- âŒ æ˜¾ç¤ºç ´æŸå›¾æ ‡

**ç°åœ¨**ï¼š
- âœ… ç»å¯¹è·¯å¾„å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º
- âœ… å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºå‹å¥½å ä½ç¬¦

### æ— éœ€è¿ç§»ç›¸å¯¹è·¯å¾„

ç›¸å¯¹è·¯å¾„å®Œå…¨å‘åå…¼å®¹ï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹ã€‚

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### Base64 è½¬æ¢å¼€é”€

æ‰€æœ‰æœ¬åœ°å›¾ç‰‡ï¼ˆåŒ…æ‹¬ç»å¯¹è·¯å¾„ï¼‰éƒ½ä¼šè¢«è½¬æ¢ä¸º Base64ï¼š

- **ä¼˜ç‚¹**ï¼šå®Œå…¨ç»•è¿‡æ²™ç®±é™åˆ¶ï¼ŒåŠ è½½å¯é 
- **ç¼ºç‚¹**ï¼šå¢åŠ çº¦ 33% çš„æ•°æ®å¤§å°

### å»ºè®®

å¯¹äºå¤§å‹å›¾ç‰‡ï¼ˆ> 5MBï¼‰ï¼Œè€ƒè™‘ï¼š
1. ä½¿ç”¨ç½‘ç»œ URLï¼ˆå¦‚æœå¯ä»¥ï¼‰
2. ä¼˜åŒ–å›¾ç‰‡å°ºå¯¸
3. ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆæ€§èƒ½ç›¸åŒï¼Œä½†æ›´è§„èŒƒï¼‰

---

## ğŸ› æ•…éšœæ’æŸ¥

### ç»å¯¹è·¯å¾„å›¾ç‰‡ä¸æ˜¾ç¤º

**æ£€æŸ¥æ¸…å•ï¼š**

1. **æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Ÿ**
   ```bash
   ls -la /path/to/image.png
   ```

2. **æƒé™æ˜¯å¦æ­£ç¡®ï¼Ÿ**
   ```bash
   # åº”è¯¥è‡³å°‘æœ‰è¯»æƒé™
   ls -l /path/to/image.png
   # -r--r--r-- æˆ– -rw-r--r--
   ```

3. **è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼Ÿ**
   - macOS è·¯å¾„åŒºåˆ†å¤§å°å†™ï¼ˆæŸäº›æƒ…å†µä¸‹ï¼‰
   - ç¡®ä¿æ²¡æœ‰æ‹¼å†™é”™è¯¯
   - ç¡®ä¿æ²¡æœ‰å¤šä½™ç©ºæ ¼

4. **æŸ¥çœ‹æ—¥å¿—ï¼š**
   ```bash
   log stream --predicate 'subsystem == "com.markdownquicklook.app"' --level debug
   ```
   
   æŸ¥æ‰¾ï¼š
   - `ğŸ”µ Trying to load` - æ˜¯å¦å°è¯•åŠ è½½
   - `ğŸŸ¢ Collected` - æ˜¯å¦æˆåŠŸ
   - `ğŸ”´ Failed` - å¤±è´¥åŸå› 

---

## ğŸ” æƒé™å¯¹è¯æ¡†è¯´æ˜

### é¦–æ¬¡ä½¿ç”¨æ—¶çš„æƒé™è¯·æ±‚

é¦–æ¬¡æ‰“å¼€åŒ…å«å›¾ç‰‡çš„ Markdown æ–‡ä»¶æ—¶ï¼ŒmacOS ä¼šæ˜¾ç¤ºæƒé™å¯¹è¯æ¡†ï¼š

```
"FluxMarkdown.app" would like to
access files in your home folder.

Keeping app data separate makes it easier to 
manage your privacy and security.

[Don't Allow]  [Allow]
```

### å¦‚ä½•å¤„ç†

1. **ç‚¹å‡» "Allow"ï¼ˆå…è®¸ï¼‰**ï¼š
   - âœ… åº”ç”¨å¯ä»¥è®¿é—®æ‚¨ä¸»ç›®å½•ä¸‹çš„æ‰€æœ‰å›¾ç‰‡
   - âœ… ç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„å›¾ç‰‡éƒ½èƒ½æ­£å¸¸æ˜¾ç¤º
   - âœ… ä»…éœ€æˆæƒä¸€æ¬¡ï¼Œåç»­ä¸å†å¼¹å‡º
   
2. **ç‚¹å‡» "Don't Allow"ï¼ˆä¸å…è®¸ï¼‰**ï¼š
   - âš ï¸  ç»å¯¹è·¯å¾„å›¾ç‰‡æ— æ³•æ˜¾ç¤º
   - âš ï¸  ä¸Šå±‚ç›®å½•ï¼ˆ`../`ï¼‰å›¾ç‰‡å¯èƒ½æ— æ³•æ˜¾ç¤º
   - âœ… åŒç›®å½•å’Œå­ç›®å½•çš„ç›¸å¯¹è·¯å¾„ä»å¯æ­£å¸¸å·¥ä½œ

### ä¸ºä»€ä¹ˆéœ€è¦æ­¤æƒé™ï¼Ÿ

- Markdown æ–‡ä»¶ç»å¸¸å¼•ç”¨ç›¸å¯¹è·¯å¾„å›¾ç‰‡ï¼ˆå¦‚ `../images/pic.png`ï¼‰
- è¿™äº›å›¾ç‰‡å¯èƒ½ä½äº Markdown æ–‡ä»¶æ‰€åœ¨ç›®å½•ä¹‹å¤–
- æ²™ç›’ç¯å¢ƒé»˜è®¤ä»…å…è®¸è®¿é—®å½“å‰æ–‡ä»¶ï¼Œéœ€è¦é¢å¤–æˆæƒæ‰èƒ½è®¿é—®å…¶ä»–æ–‡ä»¶

### å®‰å…¨æ€§ä¿è¯

- ğŸ”’ ä»…èƒ½è®¿é—®**æ‚¨çš„**ä¸»ç›®å½•ï¼ˆ`/Users/username/`ï¼‰
- ğŸ”’ **æ— æ³•**è®¿é—®ç³»ç»Ÿæ–‡ä»¶ï¼ˆ`/System/`, `/Library/`ï¼‰
- ğŸ”’ **æ— æ³•**è®¿é—®å…¶ä»–ç”¨æˆ·çš„æ–‡ä»¶
- ğŸ”’ **æ— æ³•**è®¿é—®åº”ç”¨ç¨‹åºæ•°æ®

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- **å®ç°ç»†èŠ‚**ï¼š`docs/IMAGE_SUPPORT_IMPLEMENTED.md`
- **æ˜¾ç¤ºè¡Œä¸º**ï¼š`docs/IMAGE_DISPLAY_BEHAVIOR.md`
- **æµ‹è¯•æ–‡æ¡£**ï¼š`Tests/fixtures/images-test.md`

---

## ğŸ¯ æ€»ç»“

### æ›´æ–°å‰

- âœ… ç›¸å¯¹è·¯å¾„
- âœ… ç½‘ç»œå›¾ç‰‡
- âŒ ç»å¯¹è·¯å¾„

### æ›´æ–°å

- âœ… ç›¸å¯¹è·¯å¾„
- âœ… ç½‘ç»œå›¾ç‰‡
- âœ… **ç»å¯¹è·¯å¾„** ğŸ†•
- âœ… **file:// åè®®** ğŸ†•

**ç°åœ¨æ”¯æŒæ‰€æœ‰æœ¬åœ°å›¾ç‰‡è·¯å¾„æ–¹å¼ï¼** ğŸ‰
